"""Test the atomic orbital code."""

from __future__ import annotations

import sys
from unittest import TestCase, mock

import numpy as np
from PySide6.QtGui import QSurfaceFormat
from PySide6.QtWidgets import QApplication

from molara.eval.aos import calculate_aos
from molara.gui.main_window import MainWindow
from molara.structure.molecule import Molecule

__copyright__ = "Copyright 2024, Molara"


class TestAtomicOrbitals(TestCase):
    """Test the molecular orbital code."""

    def setUp(self) -> None:
        """Initialize the program."""
        _format = QSurfaceFormat()
        _format.setVersion(3, 3)
        _format.setSamples(4)
        _format.setProfile(QSurfaceFormat.CoreProfile)  # type: ignore[attr-defined]
        QSurfaceFormat.setDefaultFormat(_format)
        self.app = QApplication([]) if QApplication.instance() is None else QApplication.instance()
        self.main_window = MainWindow()
        self.main_window.show()
        testargs = ["molara", "examples/molden/SPDFG_orbitals.molden"]
        with mock.patch.object(sys, "argv", testargs):
            self.main_window.show_init_xyz()

        if isinstance(self.main_window.structure_widget.structures[0], Molecule):
            self.mos = self.main_window.structure_widget.structures[0].mos
            self.aos = self.main_window.structure_widget.structures[0].basis_set

    def test_ao_evaluation(self) -> None:
        """Test Camera setup."""
        electron_coords = np.array([0.10154165, 0.465418564, -1.498185465])
        # get the all the different basis functions
        # Generated after comparing the mos with the mos of multiwfn.
        compare_vals = []
        reference = np.array(
            [
                [0.04209915279640994, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [
                    0.009365655761240236,
                    0.04292770558007238,
                    -0.13818457087986685,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.009365655761240236,
                    0.04292770558007238,
                    -0.13818457087986685,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.009365655761240236,
                    0.04292770558007238,
                    -0.13818457087986685,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.001202935657810266,
                    0.025272102242695858,
                    0.261869624147369,
                    0.009549981089337136,
                    -0.030741452889424845,
                    -0.14090417931035948,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.001202935657810266,
                    0.025272102242695858,
                    0.261869624147369,
                    0.009549981089337136,
                    -0.030741452889424845,
                    -0.14090417931035948,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.001202935657810266,
                    0.025272102242695858,
                    0.261869624147369,
                    0.009549981089337136,
                    -0.030741452889424845,
                    -0.14090417931035948,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.00208354567756367,
                    0.043772565098424594,
                    0.45357149398220886,
                    0.016541052458053894,
                    -0.053245758302968904,
                    -0.24405319756433805,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.00208354567756367,
                    0.043772565098424594,
                    0.45357149398220886,
                    0.016541052458053894,
                    -0.053245758302968904,
                    -0.24405319756433805,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.00208354567756367,
                    0.043772565098424594,
                    0.45357149398220886,
                    0.016541052458053894,
                    -0.053245758302968904,
                    -0.24405319756433805,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.00011968017933312278,
                    0.011524462744661838,
                    -0.3844026037946916,
                    0.005622198886342928,
                    0.0012266106161322424,
                    -0.003948467763103708,
                    0.05825724726457604,
                    0.2670234762235192,
                    -0.08295213494027488,
                    -0.03134647495456087,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.00011968017933312278,
                    0.011524462744661838,
                    -0.3844026037946916,
                    0.005622198886342928,
                    0.0012266106161322424,
                    -0.003948467763103708,
                    0.05825724726457604,
                    0.2670234762235192,
                    -0.08295213494027488,
                    -0.03134647495456087,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.00011968017933312278,
                    0.011524462744661838,
                    -0.3844026037946916,
                    0.005622198886342928,
                    0.0012266106161322424,
                    -0.003948467763103708,
                    0.05825724726457604,
                    0.2670234762235192,
                    -0.08295213494027488,
                    -0.03134647495456087,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.000267613016548228,
                    0.025769482101227672,
                    -0.859550352812849,
                    0.012571618892886402,
                    0.002742784719594594,
                    -0.008829042325266427,
                    0.1302671650656057,
                    0.5970826444240878,
                    -0.1854866126051901,
                    -0.07009284885339273,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.000267613016548228,
                    0.025769482101227672,
                    -0.859550352812849,
                    0.012571618892886402,
                    0.002742784719594594,
                    -0.008829042325266427,
                    0.1302671650656057,
                    0.5970826444240878,
                    -0.1854866126051901,
                    -0.07009284885339273,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.000267613016548228,
                    0.025769482101227672,
                    -0.859550352812849,
                    0.012571618892886402,
                    0.002742784719594594,
                    -0.008829042325266427,
                    0.1302671650656057,
                    0.5970826444240878,
                    -0.1854866126051901,
                    -0.07009284885339273,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.000267613016548228,
                    0.025769482101227672,
                    -0.859550352812849,
                    0.012571618892886402,
                    0.002742784719594594,
                    -0.008829042325266427,
                    0.1302671650656057,
                    0.5970826444240878,
                    -0.1854866126051901,
                    -0.07009284885339273,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.000267613016548228,
                    0.025769482101227672,
                    -0.859550352812849,
                    0.012571618892886402,
                    0.002742784719594594,
                    -0.008829042325266427,
                    0.1302671650656057,
                    0.5970826444240878,
                    -0.1854866126051901,
                    -0.07009284885339273,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.000267613016548228,
                    0.025769482101227672,
                    -0.859550352812849,
                    0.012571618892886402,
                    0.002742784719594594,
                    -0.008829042325266427,
                    0.1302671650656057,
                    0.5970826444240878,
                    -0.1854866126051901,
                    -0.07009284885339273,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0004635193414283015,
                    0.044634052284063114,
                    -1.4887848827356083,
                    0.021774682655872044,
                    0.004750642488561393,
                    -0.015292349889537512,
                    0.22562934845159058,
                    1.034177476460102,
                    -0.321272237156035,
                    -0.12140437546132214,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    1.006324499980451e-05,
                    0.004441564659122467,
                    0.47689580124797804,
                    0.00012203560311600079,
                    -0.00039283342123177774,
                    0.0025638081464894663,
                    -0.03782743435938957,
                    -0.08551674372821372,
                    -0.3919680255731637,
                    0.0007221217273084439,
                    0.007482628216003094,
                    0.1572002160640393,
                    -0.004026177496887233,
                    -0.018454080163266707,
                    0.05940380725885916,
                ],
                [
                    1.006324499980451e-05,
                    0.004441564659122467,
                    0.47689580124797804,
                    0.00012203560311600079,
                    -0.00039283342123177774,
                    0.0025638081464894663,
                    -0.03782743435938957,
                    -0.08551674372821372,
                    -0.3919680255731637,
                    0.0007221217273084439,
                    0.007482628216003094,
                    0.1572002160640393,
                    -0.004026177496887233,
                    -0.018454080163266707,
                    0.05940380725885916,
                ],
                [
                    1.006324499980451e-05,
                    0.004441564659122467,
                    0.47689580124797804,
                    0.00012203560311600079,
                    -0.00039283342123177774,
                    0.0025638081464894663,
                    -0.03782743435938957,
                    -0.08551674372821372,
                    -0.3919680255731637,
                    0.0007221217273084439,
                    0.007482628216003094,
                    0.1572002160640393,
                    -0.004026177496887233,
                    -0.018454080163266707,
                    0.05940380725885916,
                ],
                [
                    2.6624843651796966e-05,
                    0.011751275520051417,
                    1.261747691393036,
                    0.00032287585694071715,
                    -0.0010393395392539646,
                    0.006783198764892584,
                    -0.10008198405056469,
                    -0.22625603683689607,
                    -1.037049917555597,
                    0.0019105545067745423,
                    0.019797173412699084,
                    0.41591267775106894,
                    -0.01065226439096815,
                    -0.048824906786453945,
                    0.15716770093735488,
                ],
                [
                    2.6624843651796966e-05,
                    0.011751275520051417,
                    1.261747691393036,
                    0.00032287585694071715,
                    -0.0010393395392539646,
                    0.006783198764892584,
                    -0.10008198405056469,
                    -0.22625603683689607,
                    -1.037049917555597,
                    0.0019105545067745423,
                    0.019797173412699084,
                    0.41591267775106894,
                    -0.01065226439096815,
                    -0.048824906786453945,
                    0.15716770093735488,
                ],
                [
                    2.6624843651796966e-05,
                    0.011751275520051417,
                    1.261747691393036,
                    0.00032287585694071715,
                    -0.0010393395392539646,
                    0.006783198764892584,
                    -0.10008198405056469,
                    -0.22625603683689607,
                    -1.037049917555597,
                    0.0019105545067745423,
                    0.019797173412699084,
                    0.41591267775106894,
                    -0.01065226439096815,
                    -0.048824906786453945,
                    0.15716770093735488,
                ],
                [
                    2.6624843651796966e-05,
                    0.011751275520051417,
                    1.261747691393036,
                    0.00032287585694071715,
                    -0.0010393395392539646,
                    0.006783198764892584,
                    -0.10008198405056469,
                    -0.22625603683689607,
                    -1.037049917555597,
                    0.0019105545067745423,
                    0.019797173412699084,
                    0.41591267775106894,
                    -0.01065226439096815,
                    -0.048824906786453945,
                    0.15716770093735488,
                ],
                [
                    2.6624843651796966e-05,
                    0.011751275520051417,
                    1.261747691393036,
                    0.00032287585694071715,
                    -0.0010393395392539646,
                    0.006783198764892584,
                    -0.10008198405056469,
                    -0.22625603683689607,
                    -1.037049917555597,
                    0.0019105545067745423,
                    0.019797173412699084,
                    0.41591267775106894,
                    -0.01065226439096815,
                    -0.048824906786453945,
                    0.15716770093735488,
                ],
                [
                    2.6624843651796966e-05,
                    0.011751275520051417,
                    1.261747691393036,
                    0.00032287585694071715,
                    -0.0010393395392539646,
                    0.006783198764892584,
                    -0.10008198405056469,
                    -0.22625603683689607,
                    -1.037049917555597,
                    0.0019105545067745423,
                    0.019797173412699084,
                    0.41591267775106894,
                    -0.01065226439096815,
                    -0.048824906786453945,
                    0.15716770093735488,
                ],
                [
                    3.437252535292864e-05,
                    0.015170831461951348,
                    1.6289092652936283,
                    0.000416830938941282,
                    -0.0013417815755284983,
                    0.0087570719501479,
                    -0.12920528582774446,
                    -0.2920952875493968,
                    -1.3388256866262005,
                    0.0024665152622531097,
                    0.025558040976454605,
                    0.536940958135474,
                    -0.013752014195205981,
                    -0.06303268362135521,
                    0.20290262943069445,
                ],
                [
                    3.437252535292864e-05,
                    0.015170831461951348,
                    1.6289092652936283,
                    0.000416830938941282,
                    -0.0013417815755284983,
                    0.0087570719501479,
                    -0.12920528582774446,
                    -0.2920952875493968,
                    -1.3388256866262005,
                    0.0024665152622531097,
                    0.025558040976454605,
                    0.536940958135474,
                    -0.013752014195205981,
                    -0.06303268362135521,
                    0.20290262943069445,
                ],
                [
                    3.437252535292864e-05,
                    0.015170831461951348,
                    1.6289092652936283,
                    0.000416830938941282,
                    -0.0013417815755284983,
                    0.0087570719501479,
                    -0.12920528582774446,
                    -0.2920952875493968,
                    -1.3388256866262005,
                    0.0024665152622531097,
                    0.025558040976454605,
                    0.536940958135474,
                    -0.013752014195205981,
                    -0.06303268362135521,
                    0.20290262943069445,
                ],
                [
                    5.9534960295721776e-05,
                    0.026276650885164166,
                    2.821353608408256,
                    0.000721972364412941,
                    -0.0023240338614751764,
                    0.015167693543192433,
                    -0.22379011966011242,
                    -0.5059238786869962,
                    -2.3189141117148675,
                    0.004272129751866459,
                    0.04426782551314666,
                    0.9300090201553546,
                    -0.023819187292505185,
                    -0.10917581056960185,
                    0.35143766316328295,
                ],
                [
                    5.9534960295721776e-05,
                    0.026276650885164166,
                    2.821353608408256,
                    0.000721972364412941,
                    -0.0023240338614751764,
                    0.015167693543192433,
                    -0.22379011966011242,
                    -0.5059238786869962,
                    -2.3189141117148675,
                    0.004272129751866459,
                    0.04426782551314666,
                    0.9300090201553546,
                    -0.023819187292505185,
                    -0.10917581056960185,
                    0.35143766316328295,
                ],
                [
                    5.9534960295721776e-05,
                    0.026276650885164166,
                    2.821353608408256,
                    0.000721972364412941,
                    -0.0023240338614751764,
                    0.015167693543192433,
                    -0.22379011966011242,
                    -0.5059238786869962,
                    -2.3189141117148675,
                    0.004272129751866459,
                    0.04426782551314666,
                    0.9300090201553546,
                    -0.023819187292505185,
                    -0.10917581056960185,
                    0.35143766316328295,
                ],
            ],
        )
        for i in range(len(self.aos)):
            ao = self.aos[i]
            aos_vals = np.zeros(15, dtype=np.float64)
            shell = sum(ao.ijk)
            _ = calculate_aos(
                electron_coords,
                ao.position,
                ao.exponents,
                ao.coefficients,
                ao.norms,
                shell,
                aos_vals,
            )
            compare_vals.append(aos_vals)
        compare_vals = np.array(compare_vals)
        test_vals = compare_vals - reference
        assert test_vals.all() == 0.0
